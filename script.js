let comprobantes=[];let choferNombre="";let fechaRuta=new Date().toLocaleString();document.getElementById("scanBtn").onclick=()=>{document.getElementById("imageInput").click();};document.getElementById("imageInput").addEventListener("change",async(e)=>{const files=e.target.files;for(let file of files){const image=URL.createObjectURL(file);const result=await Tesseract.recognize(image,"spa",{logger:m=>console.log(m)});procesarOCR(result.data.text);}renderComprobantes();});function procesarOCR(texto){const lineas=texto.split("\n").map(l=>l.trim()).filter(Boolean);let tipo="";let numero="";lineas.forEach((line,i)=>{if(line.toUpperCase().startsWith("VENTAS")) tipo=line;if(/^\d{6,}$/.test(line)) numero=line;});if(tipo&&numero){comprobantes.push({tipo,numero,estado:"",observacion:""});}}function renderComprobantes(){const cont=document.getElementById("listaComprobantes");cont.innerHTML="";comprobantes.forEach((c,index)=>{const div=document.createElement("div");div.className="comprobante";div.innerHTML=`<strong>Comprobante:</strong> ${c.numero}<br><strong>Tipo:</strong> ${c.tipo}<div class="estado-btns"><button onclick="setEstado(${index}, 'ENTREGADO')">ENTREGADO</button><button onclick="setEstado(${index}, 'AUSENTE')">AUSENTE</button><button onclick="setEstado(${index}, 'CANCELADO')">CANCELADO</button><button onclick="setEstado(${index}, 'DEMORADO')">DEMORADO</button></div><textarea id="obs_${index}" placeholder="ObservaciÃ³n..."></textarea>`;cont.appendChild(div);});}function setEstado(i,estado){comprobantes[i].estado=estado;const obs=document.getElementById(`obs_${i}`);obs.style.display=(estado==="ENTREGADO")?"none":"block";obs.oninput=()=>comprobantes[i].observacion=obs.value;renderComprobantes();}document.getElementById("generarQR").onclick=()=>{const json={fecha:fechaRuta,chofer:choferNombre||"Chofer",comprobantes};const textoQR=JSON.stringify(json);document.getElementById("qr").innerHTML="";new QRCode(document.getElementById("qr"),{text:textoQR,width:256,height:256});document.getElementById("qrModal").style.display="block";};document.getElementById("descargarQR").onclick=()=>{const canvas=document.querySelector("#qr canvas");if(!canvas) return;const url=canvas.toDataURL("image/png");const a=document.createElement("a");a.href=url;a.download="qr_ruta.png";a.click();};function cerrarQR(){document.getElementById("qrModal").style.display="none";}